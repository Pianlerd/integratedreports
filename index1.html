<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô BI ‡πÅ‡∏ö‡∏ö‡∏Ñ‡∏£‡∏ö‡∏ß‡∏á‡∏à‡∏£ ‚Äî ‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥‡∏à‡∏ô‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á 100%</title>
    
    <!-- Tailwind, XLSX, FileSaver -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/FileSaver.js/2.0.5/FileSaver.min.js"></script>
    
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f4f3; }
        
        .validator-line {
            font-family: 'Consolas', monospace;
            border-left: 4px solid #0b7b69;
            background: #eefaf8;
            padding: 10px 14px;
            margin: 8px 0;
            border-radius: 0 8px 8px 0;
        }
        .error-tag {
            background: #dc2626;
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
            font-size: 0.7rem;
            font-weight: 600;
        }
        .success-tag {
            background: #0b7b69;
            color: white;
            padding: 2px 10px;
            border-radius: 20px;
        }
        #ai-status-container {
            background: #0a1e1c;
            color: #ccf0e8;
            border-radius: 0.75rem;
            padding: 1.25rem;
            max-height: 360px;
            overflow-y: auto;
            font-size: 0.8rem;
            line-height: 1.6;
            border: 1px solid #1e3a3a;
            display: none;
        }
        .status-line { display: flex; align-items: baseline; gap: 0.6rem; }
        .loader { width: 14px; height: 14px; border: 2px solid #99f6e4; border-top: 2px solid #0f766e; border-radius: 50%; animation: spin 0.8s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        #message-box { position: fixed; inset: 0; background: rgba(0,0,0,0.5); display: none; align-items: center; justify-content: center; z-index: 10000; }
        #message-box.active { display: flex; }
        .message-content { background: white; padding: 2rem; border-radius: 20px; max-width: 420px; width: 90%; }
        .copy-btn { transition: 0.2s; position: absolute; top: 12px; right: 12px; padding: 5px 16px; border-radius: 40px; font-size: 0.8rem; font-weight: 600; background: #1e293b; color: white; box-shadow: 0 2px 6px rgba(0,0,0,0.1); }
        .copy-btn:hover { background: #0f172a; }
        .table-schema-badge {
            background: #e6f3f0; 
            border-radius: 12px; 
            padding: 2px 10px; 
            font-size: 0.7rem; 
            color: #115e59;
        }
    </style>
</head>
<body class="p-5 md:p-7 bg-gray-100">

<div class="max-w-7xl mx-auto">
    <!-- header -->
    <div class="bg-white rounded-3xl shadow-lg p-7 md:p-9 mb-7 border-b-4 border-teal-600">
        <h1 class="text-3xl md:text-4xl font-bold text-center text-teal-800 mb-3 tracking-tight">
            üß† ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô Power BI + DAX ¬∑ ‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ 100%
        </h1>
        <p class="text-center text-gray-700 text-lg max-w-3xl mx-auto">
            ‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏ó‡∏∏‡∏Å‡∏ï‡∏≤‡∏£‡∏≤‡∏á ¬∑ ‡πÇ‡∏Ñ‡πâ‡∏î M / DAX ‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á Dashboard ¬∑ ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        </p>
        <p class="text-center text-sm text-teal-600 font-medium mt-3">
            ‚ö° ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡∏™‡∏π‡∏ï‡∏£‡∏à‡∏∞‡πÉ‡∏ä‡πâ‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á ‚Äî ‡πÄ‡∏õ‡∏•‡∏∑‡∏≠‡∏á API Key ‡πÅ‡∏ï‡πà‡πÑ‡∏î‡πâ‡∏á‡∏≤‡∏ô‡∏£‡∏∞‡∏î‡∏±‡∏ö‡∏≠‡∏á‡∏Ñ‡πå‡∏Å‡∏£
        </p>
    </div>

    <!-- message modal -->
    <div id="message-box">
        <div class="message-content">
            <p id="message-text" class="text-gray-800 font-medium mb-6 text-center"></p>
            <button onclick="closeMessage()" class="w-full bg-teal-700 hover:bg-teal-800 text-white py-3 rounded-xl font-semibold transition">
                ‡∏ï‡∏Å‡∏•‡∏á
            </button>
        </div>
    </div>

    <!-- main panel -->
    <div class="bg-white rounded-3xl shadow-xl p-7 md:p-9">
        <!-- 1. API key -->
        <div class="mb-8">
            <label class="block text-xl font-bold text-gray-800 mb-2">üîë 1. Gemini API Key</label>
            <input type="password" id="api-key-input" placeholder="AIzaSy..." 
                   class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-teal-200 focus:border-teal-500 text-base">
            <p class="text-sm text-gray-500 mt-2 flex items-center gap-1">
                <span class="bg-amber-100 text-amber-800 px-3 py-1 rounded-full">‡∏™‡∏≥‡∏Ñ‡∏±‡∏ç</span> 
                ‡πÉ‡∏ä‡πâ Gemini 2.5 Flash / Pro ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡πÉ‡∏ä‡πâ‡∏ã‡πâ‡∏≥‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö‡πÄ‡∏û‡∏∑‡πà‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á
            </p>
        </div>

        <!-- 2. ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå (‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå) ‡∏´‡πâ‡∏≤‡∏°‡∏Ç‡∏≤‡∏î -->
        <div class="mb-8">
            <label class="block text-xl font-bold text-gray-800 mb-2">üìÇ 2. ‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á</label>
            <div class="border-3 border-dashed border-teal-300 rounded-3xl p-6 bg-teal-50/30">
                <input type="file" id="multi-file-input" multiple 
                       accept=".xlsx,.xls,.csv,.tsv,.txt,.json,.sql,.xml,.yaml,.yml,.md,text/*"
                       class="hidden">
                
                <div id="file-drop-zone" 
                     class="border-2 border-dashed border-teal-400 rounded-xl p-9 text-center cursor-pointer hover:bg-teal-100/40 transition bg-white">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-14 w-14 mx-auto text-teal-500 mb-3" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 13h6m-3-3v6m5 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                    </svg>
                    <p class="text-gray-700 font-medium text-lg mb-1">‡∏•‡∏≤‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏°‡∏≤‡∏ß‡∏≤‡∏á ‡∏´‡∏£‡∏∑‡∏≠‡∏Ñ‡∏•‡∏¥‡∏Å‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏•‡∏∑‡∏≠‡∏Å (‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå)</p>
                    <p class="text-gray-500 text-sm">Excel, CSV, TSV, JSON, SQL, TXT, XML, YAML ‚Äî ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏≠‡πà‡∏≤‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•</p>
                    <p class="text-red-600 text-xs mt-3 font-semibold">‚ö†Ô∏è ‡∏ï‡πâ‡∏≠‡∏á‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡πÑ‡∏ü‡∏•‡πå‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå</p>
                </div>

                <div id="file-list" class="mt-5 space-y-2 max-h-64 overflow-y-auto hidden"></div>
                <div id="file-preview" class="hidden mt-4 p-4 bg-teal-50 rounded-xl text-sm text-teal-800"></div>
            </div>
            <p class="text-xs text-gray-500 mt-3 flex items-center gap-2">
                <span class="bg-blue-100 text-blue-800 px-3 py-1 rounded-full">schema</span>
                ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏à‡∏î‡∏à‡∏≥‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡πÑ‡∏ü‡∏•‡πå, ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå, ‡∏ä‡∏ô‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•, ‡∏Ñ‡πà‡∏≤‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á ‚Äî ‡∏´‡πâ‡∏≤‡∏°‡∏°‡πÇ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°
            </p>
        </div>

        <!-- 3. ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ -->
        <div class="mb-8">
            <label class="block text-xl font-bold text-gray-800 mb-2">üéØ 3. ‡∏ö‡∏£‡∏¥‡∏ö‡∏ó + ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</label>
            <textarea id="analysis-context" rows="5" 
                      class="w-full p-4 border-2 border-gray-300 rounded-2xl focus:ring-4 focus:ring-teal-200 text-base resize-y"
                      placeholder="‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á:&#10;‚Ä¢ ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏î‡∏π‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏†‡∏π‡∏°‡∏¥‡∏†‡∏≤‡∏Ñ &#10;‚Ä¢ ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡πÉ‡∏ô Power Query &#10;‚Ä¢ Dashboard ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡∏ï‡∏±‡∏ß‡∏Å‡∏£‡∏≠‡∏á‡∏õ‡∏µ ‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà &#10;‚Ä¢ ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏à‡∏≤‡∏Å‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á"
>‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£ Dashboard ‡∏ó‡∏µ‡πà‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢‡πÉ‡∏ä‡πâ‡πÅ‡∏•‡πâ‡∏ß‡πÄ‡∏Ç‡πâ‡∏≤‡πÉ‡∏à‡∏ó‡∏±‡∏ô‡∏ó‡∏µ
- ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô Power Query ‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡πÄ‡∏ä‡πà‡∏ô 'sale_date' ‚Üí '‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢')
- DAX Measures ‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏ä‡πà‡∏ô '‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡∏£‡∏ß‡∏°' , '‡∏Å‡∏≥‡πÑ‡∏£‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡πâ‡∏ô'
- ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡πÉ‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÄ‡∏™‡∏£‡∏¥‡∏°‡∏°‡∏±‡πà‡∏ß
- ‡πÉ‡∏™‡πà‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏Å‡∏≤‡∏£‡∏ó‡∏≥‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</textarea>
        </div>

        <!-- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå -->
        <button id="analyze-btn" 
                class="w-full bg-gradient-to-r from-teal-700 to-emerald-700 hover:from-teal-800 hover:to-emerald-800 text-white py-5 px-6 rounded-2xl font-bold text-xl transition-all active:scale-[0.98] shadow-xl mb-7 flex items-center justify-center gap-3">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-7 w-7" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19.428 15.428a2 2 0 00-1.022-.547l-2.387-.477a6 6 0 00-3.86.517l-.318.158a6 6 0 01-3.86.517L6.05 15.21a2 2 0 00-1.806.547M8 4h8l-1 1v5.172a2 2 0 00.586 1.414l5 5c1.26 1.26.367 3.414-1.415 3.414H4.828c-1.782 0-2.674-2.154-1.414-3.414l5-5A2 2 0 009 10.172V5L8 4z" />
            </svg>
            ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ö‡∏ö‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‚Äì ‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏à‡∏ô‡∏ñ‡∏π‡∏Å 100%
        </button>

        <!-- Progress + AI log -->
        <div id="progress-section" class="hidden mb-6">
            <div class="flex justify-between items-center mb-2">
                <span id="progress-text" class="font-semibold text-teal-800 text-lg">0% | ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô</span>
                <span id="time-text" class="text-gray-500 text-sm">‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ: 0.00 ‡∏ô‡∏≤‡∏ó‡∏µ</span>
            </div>
            <div class="w-full bg-gray-200 rounded-full h-4">
                <div id="progress-bar" class="bg-teal-600 h-4 rounded-full transition-all duration-500" style="width: 0%"></div>
            </div>
        </div>

        <div id="ai-status-container">
            <div id="ai-log" class="space-y-1"></div>
        </div>

        <!-- Section ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÅ‡∏•‡∏∞‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î -->
        <div id="download-section" class="hidden mt-12 pt-8 border-t-4 border-teal-200">
            <h2 class="text-3xl font-bold text-gray-800 mb-7 flex items-center gap-3">
                <span class="bg-teal-100 p-3 rounded-2xl">üìå</span> 
                ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡∏à‡∏£‡∏¥‡∏á (‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏£‡∏ö 100%)
            </h2>
            <div class="grid md:grid-cols-2 gap-7">
                <!-- ‡∏â‡∏ö‡∏±‡∏ö‡∏î‡∏±‡πâ‡∏á‡πÄ‡∏î‡∏¥‡∏° -->
                <div class="bg-gradient-to-br from-white to-red-50/30 border-2 border-red-200 rounded-2xl p-6 shadow-md">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 bg-red-600 rounded-full flex items-center justify-center text-white text-lg">üìã</div>
                        <h3 class="font-bold text-red-800 text-xl">‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å (DAX+M)</h3>
                    </div>
                    <button id="download-original-btn" class="w-full bg-red-700 hover:bg-red-800 text-white py-3 rounded-xl font-semibold shadow-md mb-2">‚¨á ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î .doc</button>
                    <button id="copy-original-btn" class="w-full bg-red-600 hover:bg-red-700 text-white py-3 rounded-xl font-semibold">üìë ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô</button>
                    <p class="text-xs text-red-700 mt-3">‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå 7 ‡∏£‡∏≠‡∏ö</p>
                </div>
                <!-- ‡∏â‡∏ö‡∏±‡∏ö‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ + ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå -->
                <div class="bg-gradient-to-br from-white to-green-50 border-2 border-green-300 rounded-2xl p-6 shadow-md">
                    <div class="flex items-center gap-2 mb-4">
                        <div class="w-8 h-8 bg-green-700 rounded-full flex items-center justify-center text-white text-lg">üáπüá≠</div>
                        <h3 class="font-bold text-green-800 text-xl">‡∏â‡∏ö‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ + M rename</h3>
                    </div>
                    <button id="enhance-report-btn" class="w-full bg-green-700 hover:bg-green-800 text-white py-3 rounded-xl font-semibold shadow-md mb-2">
                        ‚ú® ‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á/‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢
                    </button>
                    <button id="download-enhanced-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-semibold mb-2 hidden">‚¨á ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ó‡∏¢</button>
                    <button id="copy-enhanced-btn" class="w-full bg-green-600 hover:bg-green-700 text-white py-3 rounded-xl font-semibold hidden">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏â‡∏ö‡∏±‡∏ö‡πÑ‡∏ó‡∏¢</button>
                    <p class="text-xs text-green-700 mt-3">M Code ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡∏±‡∏ï‡πÇ‡∏ô‡∏°‡∏±‡∏ï‡∏¥ + ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢</p>
                </div>
            </div>
        </div>

        <!-- container ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô (textarea) -->
        <div id="results-container" class="mt-10 space-y-8"></div>
    </div>
</div>

<script>
    (function(){
        "use strict";

        // -------------------------
        // GLOBAL STATE & CONSTANTS
        // -------------------------
        let CURRENT_API_KEY = '';
        let FULL_SCHEMA = null;          // ‡πÄ‡∏Å‡πá‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î { 'fileName.xlsx': { sheets: [...] }, ... }
        let FULL_SCHEMA_TEXT = '';       // ‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢ schema ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏™‡πà‡∏á AI
        let ANALYSIS_CONTEXT = '';
        let FINAL_REPORT = '';           // ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß
        let ENHANCED_REPORT = '';        // ‡∏â‡∏ö‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ + rename

        const API_URL_TEMPLATE = "https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash:generateContent?key=";

        // ‡∏£‡∏∞‡∏ö‡∏ö‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô: ‡∏ï‡∏£‡∏ß‡∏à‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ú‡πà‡∏≤‡∏ô‡πÄ‡∏Å‡∏ì‡∏ë‡πå
        const MAX_VALIDATION_ITERATIONS = 6;   // ‡∏ï‡∏£‡∏ß‡∏à‡∏ã‡πâ‡∏≥‡∏™‡∏π‡∏á‡∏™‡∏∏‡∏î 6 ‡∏£‡∏≠‡∏ö‡∏ï‡πà‡∏≠‡∏ä‡∏¥‡πâ‡∏ô
        const REQUIRED_PASSES = 2;             // ‡∏ï‡πâ‡∏≠‡∏á‡∏ú‡πà‡∏≤‡∏ô validation 2 ‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏ï‡∏¥‡∏î

        // ---------- prompts ‡πÅ‡∏ö‡∏ö‡πÄ‡∏Ç‡πâ‡∏°‡∏á‡∏ß‡∏î ‡πÑ‡∏°‡πà‡∏°‡πÇ‡∏ô‡∏ï‡∏≤‡∏£‡∏≤‡∏á ----------
        const PROMPT_REPORT_BASE = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ô‡∏±‡∏Å‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• Power BI ‡∏£‡∏∞‡∏î‡∏±‡∏ö Senior ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏à‡∏≤‡∏Å‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô

[‡∏Å‡∏é‡πÄ‡∏´‡∏•‡πá‡∏Å]
1. ‡∏´‡πâ‡∏≤‡∏°‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡πÑ‡∏°‡πà‡∏°‡∏µ‡πÉ‡∏ô schema ‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡∏°‡∏≤‡πÇ‡∏î‡∏¢‡πÄ‡∏î‡πá‡∏î‡∏Ç‡∏≤‡∏î
2. ‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô DAX / M ‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (case sensitive)
3. ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢ ‡πÉ‡∏´‡πâ‡πÄ‡∏Ç‡∏µ‡∏¢‡∏ô M Code ‡πÄ‡∏û‡∏∑‡πà‡∏≠‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (rename columns) ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô
4. ‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Dashboard ‡πÉ‡∏´‡πâ‡πÄ‡∏´‡∏°‡∏≤‡∏∞‡∏Å‡∏±‡∏ö‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢ ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ó‡∏∏‡∏Å‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
5. DAX Measures ‡∏ï‡πâ‡∏≠‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÅ‡∏ï‡πà‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á
6. ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (Relations) ‡πÉ‡∏ä‡πâ‡∏à‡∏≤‡∏Å‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ó‡∏µ‡πà‡∏°‡∏µ‡∏≠‡∏¢‡∏π‡πà‡∏à‡∏£‡∏¥‡∏á‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô ‡πÑ‡∏°‡πà‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ñ‡∏µ‡∏¢‡πå‡πÄ‡∏ó‡∏µ‡∏¢‡∏°
7. ‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏™‡∏î‡∏á‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î M ‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏•‡∏∞‡πÇ‡∏Ñ‡πâ‡∏î DAX ‡∏ó‡∏µ‡πà‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô‡πÑ‡∏î‡πâ‡∏à‡∏£‡∏¥‡∏á

[‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢]
1. ‡∏™‡∏£‡∏∏‡∏õ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏° (Executive Summary) - ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
2. ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏•‡∏∞‡∏Ñ‡∏ß‡∏≤‡∏°‡∏™‡∏±‡∏°‡∏û‡∏±‡∏ô‡∏ò‡πå (‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏° schema ‡πÄ‡∏ó‡πà‡∏≤‡∏ô‡∏±‡πâ‡∏ô)
3. ‡∏Å‡∏≤‡∏£‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏î‡πâ‡∏ß‡∏¢ Power Query (M Code) - ‡∏û‡∏£‡πâ‡∏≠‡∏° rename columns ‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢
4. ‡∏™‡∏π‡∏ï‡∏£ DAX ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö Dashboard (‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ó‡∏¢) - ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏à‡∏≤‡∏Å‡∏ä‡∏∑‡πà‡∏≠‡∏à‡∏£‡∏¥‡∏á
5. ‡∏Å‡∏≤‡∏£‡∏≠‡∏≠‡∏Å‡πÅ‡∏ö‡∏ö Dashboard (‡∏†‡∏≤‡∏û‡∏à‡∏≥‡∏•‡∏≠‡∏á + ‡∏Ñ‡∏≥‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢)
6. ‡∏Ç‡πâ‡∏≠‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÉ‡∏ô‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô

‡∏ï‡πâ‡∏≠‡∏á‡∏£‡∏∞‡∏ö‡∏∏‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ü‡∏•‡πå‡∏ï‡πâ‡∏ô‡∏ó‡∏≤‡∏á‡πÅ‡∏•‡∏∞‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏£‡∏¥‡∏á‡∏ó‡∏∏‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á`;
        
        const PROMPT_VALIDATE_DAX_M = `‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ú‡∏π‡πâ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö Power BI ‡πÄ‡∏ä‡∏¥‡∏á‡∏£‡∏´‡∏±‡∏™.  
‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î DAX ‡πÅ‡∏•‡∏∞ M ‡∏î‡πâ‡∏≤‡∏ô‡∏•‡πà‡∏≤‡∏á‡∏ß‡πà‡∏≤‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏ï‡∏£‡∏á‡∏ï‡∏≤‡∏° schema ‡∏à‡∏£‡∏¥‡∏á‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
- ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡πÉ‡∏ô‡∏£‡∏π‡∏õ‡πÅ‡∏ö‡∏ö "ERROR: ..." ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏ß‡πà‡∏≤‡∏ú‡∏¥‡∏î‡∏ï‡∏£‡∏á‡πÑ‡∏´‡∏ô
- ‡∏ñ‡πâ‡∏≤‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î: ‡πÉ‡∏´‡πâ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö "VALIDATION_PASSED"
- ‡∏ñ‡πâ‡∏≤‡∏ï‡πâ‡∏≠‡∏á‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç: ‡πÅ‡∏ô‡∏∞‡∏ô‡∏≥‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á

**‡∏´‡πâ‡∏≤‡∏°‡∏ï‡∏≠‡∏ö‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏≠‡∏∑‡πà‡∏ô‡∏ô‡∏≠‡∏Å‡∏à‡∏≤‡∏Å ERROR ‡∏´‡∏£‡∏∑‡∏≠ VALIDATION_PASSED ‡∏´‡∏£‡∏∑‡∏≠‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ‡πÅ‡∏•‡πâ‡∏ß**`;

        // ---------- DOM refs ----------
        const el = {
            apiKey: document.getElementById('api-key-input'),
            multiFileInput: document.getElementById('multi-file-input'),
            fileDropZone: document.getElementById('file-drop-zone'),
            fileList: document.getElementById('file-list'),
            filePreview: document.getElementById('file-preview'),
            previewContent: document.getElementById('preview-content'),
            analysisContext: document.getElementById('analysis-context'),
            analyzeBtn: document.getElementById('analyze-btn'),
            progressSection: document.getElementById('progress-section'),
            progressBar: document.getElementById('progress-bar'),
            progressText: document.getElementById('progress-text'),
            timeText: document.getElementById('time-text'),
            aiStatusContainer: document.getElementById('ai-status-container'),
            aiLog: document.getElementById('ai-log'),
            downloadSection: document.getElementById('download-section'),
            resultsContainer: document.getElementById('results-container'),
            downloadOriginalBtn: document.getElementById('download-original-btn'),
            copyOriginalBtn: document.getElementById('copy-original-btn'),
            enhanceReportBtn: document.getElementById('enhance-report-btn'),
            downloadEnhancedBtn: document.getElementById('download-enhanced-btn'),
            copyEnhancedBtn: document.getElementById('copy-enhanced-btn'),
            messageBox: document.getElementById('message-box'),
            messageText: document.getElementById('message-text')
        };

        // ---------- Utility ----------
        window.showMessage = function(text) {
            el.messageText.textContent = text;
            el.messageBox.classList.add('active');
        };
        window.closeMessage = function() {
            el.messageBox.classList.remove('active');
        };

        function logAI(msg, isLoading = false, isError = false) {
            const line = document.createElement('div');
            line.className = 'status-line text-xs';
            if (isLoading) {
                line.innerHTML = `<div class="loader"></div><span class="text-teal-200">${msg}</span>`;
            } else if (isError) {
                line.innerHTML = `<span class="text-red-300 text-sm">‚ùå [${new Date().toLocaleTimeString('th-TH')}] ${msg}</span>`;
            } else {
                line.innerHTML = `<span class="text-gray-300">‚úÖ [${new Date().toLocaleTimeString('th-TH')}] ${msg}</span>`;
            }
            el.aiLog.appendChild(line);
            el.aiLog.scrollTop = el.aiLog.scrollHeight;
        }

        function updateProgress(percent, text) {
            el.progressBar.style.width = `${percent}%`;
            el.progressText.textContent = `${percent}% | ${text}`;
            if (window.ANALYSIS_START_TIME) {
                const mins = (Date.now() - window.ANALYSIS_START_TIME) / 60000;
                el.timeText.textContent = `‚è±Ô∏è ${mins.toFixed(2)} ‡∏ô‡∏≤‡∏ó‡∏µ`;
            }
        }

        // ---------- FILE SCHEMA PARSING (‡πÄ‡∏Ç‡πâ‡∏°‡∏Ç‡πâ‡∏ô) ----------
        async function readFileSchema(files) {
            const schema = {};
            for (const file of files) {
                const ext = file.name.split('.').pop().toLowerCase();
                try {
                    if (['xlsx','xls'].includes(ext)) {
                        schema[file.name] = await parseExcel(file);
                    } else if (ext === 'csv') {
                        schema[file.name] = await parseDelimited(file, ',');
                    } else if (ext === 'tsv') {
                        schema[file.name] = await parseDelimited(file, '\t');
                    } else if (ext === 'json') {
                        schema[file.name] = await parseJSON(file);
                    } else {
                        schema[file.name] = await parseTextAsTable(file);
                    }
                } catch(e) {
                    logAI(`‚ö†Ô∏è ‡∏≠‡πà‡∏≤‡∏ô‡πÑ‡∏ü‡∏•‡πå ${file.name} ‡πÑ‡∏°‡πà‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå: ${e.message}`, false, true);
                    schema[file.name] = { error: e.message, columns: [], sample: [] };
                }
            }
            return schema;
        }

        async function parseExcel(file) {
            const ab = await file.arrayBuffer();
            const wb = XLSX.read(ab);
            const sheets = {};
            wb.SheetNames.forEach(sheetName => {
                const ws = wb.Sheets[sheetName];
                const data = XLSX.utils.sheet_to_json(ws, { header: 1, defval: '' });
                if (data.length < 2) return;
                const headers = data[0].filter(h => h && h.toString().trim() !== '').map(h => h.toString().trim());
                if (headers.length === 0) return;
                const rows = data.slice(1, 11).map(r => r.map(c => c?.toString?.() ?? ''));
                sheets[sheetName] = {
                    columns: headers,
                    sample: rows,
                    rowCount: data.length - 1
                };
            });
            return { type: 'excel', sheets };
        }

        async function parseDelimited(file, delim) {
            const text = await file.text();
            const lines = text.split('\n').filter(l => l.trim() !== '');
            if (lines.length === 0) return { columns: [], sample: [] };
            const headers = lines[0].split(delim).map(h => h.trim().replace(/^["']|["']$/g, ''));
            const sample = lines.slice(1, 11).map(line => line.split(delim).map(c => c.trim()));
            return { type: 'csv', columns: headers, sample, rowCount: lines.length-1 };
        }

        async function parseJSON(file) {
            const text = await file.text();
            const json = JSON.parse(text);
            let columns = [], sample = [];
            if (Array.isArray(json) && json.length > 0) {
                columns = Object.keys(json[0]);
                sample = json.slice(0,10).map(obj => columns.map(col => String(obj[col] ?? '')));
            } else if (typeof json === 'object') {
                columns = Object.keys(json);
                sample = [columns.map(col => String(json[col] ?? ''))];
            }
            return { type: 'json', columns, sample, rowCount: sample.length };
        }

        async function parseTextAsTable(file) {
            const text = await file.text();
            const lines = text.split('\n').filter(l => l.trim() !== '');
            if (lines.length === 0) return { columns: ['content'], sample: [] };
            return { type: 'text', columns: ['‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà', '‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤'], sample: lines.slice(0,10).map((l,i)=>[i+1, l.substring(0,80)]) };
        }

        // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏° schema ‡∏ó‡∏µ‡πà‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î ‡∏™‡πà‡∏á‡πÉ‡∏´‡πâ AI
        function buildSchemaText(schemaObj) {
            let txt = "===== ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á (‡∏´‡πâ‡∏≤‡∏°‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏≠‡∏∑‡πà‡∏ô) =====\n";
            for (const [fname, content] of Object.entries(schemaObj)) {
                txt += `\nüìÅ ‡πÑ‡∏ü‡∏•‡πå: ${fname}\n`;
                if (content.error) { txt += `   ‚ùå ERROR: ${content.error}\n`; continue; }
                if (content.sheets) {
                    for (const [sheetName, sheet] of Object.entries(content.sheets)) {
                        txt += `   üìÑ ‡πÅ‡∏ú‡πà‡∏ô: ${sheetName}\n`;
                        txt += `      ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (${sheet.columns.length}): ${sheet.columns.join(' | ')}\n`;
                        if (sheet.sample.length) {
                            txt += `      ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÅ‡∏ñ‡∏ß‡∏ó‡∏µ‡πà 1: ${sheet.sample[0].join(' | ')}\n`;
                        }
                    }
                } else {
                    txt += `   üìÑ ‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏´‡∏•‡∏±‡∏Å\n`;
                    txt += `      ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå (${content.columns?.length || 0}): ${content.columns?.join(' | ') || '-'}\n`;
                    if (content.sample?.length) {
                        txt += `      ‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á: ${content.sample[0]?.join(' | ') || ''}\n`;
                    }
                }
            }
            txt += "\n================= ‡∏à‡∏ö‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á =================\n";
            return txt;
        }

        // ---------- MULTI FILE HANDLER (‡πÄ‡∏Å‡πá‡∏ö files ‡∏´‡∏•‡∏≤‡∏¢‡πÑ‡∏ü‡∏•‡πå) ----------
        function handleFiles(newFiles) {
            const dt = new DataTransfer();
            if (el.multiFileInput.files) {
                Array.from(el.multiFileInput.files).forEach(f => dt.items.add(f));
            }
            Array.from(newFiles).forEach(f => dt.items.add(f));
            el.multiFileInput.files = dt.files;
            updateFileList();
        }

        function updateFileList() {
            const files = el.multiFileInput.files;
            el.fileList.innerHTML = '';
            if (files.length > 0) {
                el.fileList.classList.remove('hidden');
                el.filePreview.classList.remove('hidden');
                Array.from(files).forEach((f, idx) => {
                    const item = document.createElement('div');
                    item.className = 'flex justify-between items-center bg-white p-3 rounded-xl border shadow-sm';
                    item.innerHTML = `<div class="flex gap-2"><span class="bg-teal-100 px-2 py-1 rounded-lg text-xs">${f.name}</span><span class="text-gray-400 text-xs">${(f.size/1024).toFixed(1)} KB</span></div>
                                     <button class="text-red-600 remove-file text-sm" data-index="${idx}">‚ùå</button>`;
                    el.fileList.appendChild(item);
                });
                document.querySelectorAll('.remove-file').forEach(btn => {
                    btn.addEventListener('click', (e) => {
                        const idx = parseInt(e.target.dataset.index);
                        const dt = new DataTransfer();
                        const arr = Array.from(el.multiFileInput.files);
                        arr.splice(idx, 1);
                        arr.forEach(f => dt.items.add(f));
                        el.multiFileInput.files = dt.files;
                        updateFileList();
                    });
                });
                el.previewContent.innerHTML = `<span class="text-teal-700 font-medium">‚úÖ ‡∏û‡∏£‡πâ‡∏≠‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå ${files.length} ‡πÑ‡∏ü‡∏•‡πå</span>`;
            } else {
                el.fileList.classList.add('hidden');
                el.filePreview.classList.add('hidden');
            }
        }

        // drop zone
        el.fileDropZone.addEventListener('click', () => el.multiFileInput.click());
        el.multiFileInput.addEventListener('change', () => updateFileList());
        el.fileDropZone.addEventListener('dragover', (e) => { e.preventDefault(); el.fileDropZone.classList.add('bg-teal-100'); });
        el.fileDropZone.addEventListener('dragleave', (e) => { e.preventDefault(); el.fileDropZone.classList.remove('bg-teal-100'); });
        el.fileDropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            el.fileDropZone.classList.remove('bg-teal-100');
            if (e.dataTransfer.files.length) handleFiles(e.dataTransfer.files);
        });

        // ---------- GEMINI CALL ----------
        async function callGemini(prompt, system, apiKey) {
            const url = API_URL_TEMPLATE + apiKey;
            const res = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                    contents: [{ parts: [{ text: prompt }] }],
                    system_instruction: { parts: [{ text: system }] }
                })
            });
            if (!res.ok) {
                const err = await res.json();
                throw new Error(`Gemini Error ${res.status}: ${err.error?.message || 'no message'}`);
            }
            const data = await res.json();
            return data.candidates?.[0]?.content?.parts?.[0]?.text || '';
        }

        // ---------- VALIDATION ENGINE ----------
        // ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö DAX / M ‡∏ß‡∏ô‡πÑ‡∏õ‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏¢‡πÜ ‡∏à‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô REQUIRED_PASSES ‡∏ï‡∏¥‡∏î
        async function validateAndFix(apiKey, code, schemaText, codeType = 'DAX') {
            let currentCode = code;
            let passCount = 0;
            for (let i = 0; i < MAX_VALIDATION_ITERATIONS; i++) {
                logAI(`üîç ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö ${codeType} ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${i+1}...`, true);
                const checkPrompt = `Schema: ${schemaText}\n\n‡πÇ‡∏Ñ‡πâ‡∏î ${codeType} ‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏£‡∏ß‡∏à:\n${currentCode}\n\n‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Å‡∏≤‡∏£‡∏≠‡πâ‡∏≤‡∏á‡∏≠‡∏¥‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á/‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå ‡∏´‡∏≤‡∏Å‡∏ú‡∏¥‡∏î‡πÉ‡∏´‡πâ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡∏∞‡πÅ‡∏™‡∏î‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á ‡∏´‡∏≤‡∏Å‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏ï‡∏≠‡∏ö VALIDATION_PASSED`;
                try {
                    const result = await callGemini(checkPrompt, PROMPT_VALIDATE_DAX_M, apiKey);
                    if (result.includes('VALIDATION_PASSED')) {
                        passCount++;
                        logAI(`‚úÖ ${codeType} ‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà ${i+1} (${passCount}/${REQUIRED_PASSES})`);
                        if (passCount >= REQUIRED_PASSES) {
                            return { success: true, code: currentCode };
                        }
                    } else if (result.includes('ERROR:') || result.toLowerCase().includes('‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç') || result.toLowerCase().includes('‡∏Ñ‡∏ß‡∏£')) {
                        passCount = 0; // reset ‡∏ñ‡πâ‡∏≤‡∏°‡∏µ error
                        // ‡∏î‡∏∂‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡πÅ‡∏Å‡πâ
                        const fixed = extractCodeFromText(result);
                        if (fixed) currentCode = fixed;
                        logAI(`‚ö†Ô∏è ${codeType} ‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÅ‡∏•‡πâ‡∏ß`, false, true);
                    } else {
                        // ‡∏ñ‡πâ‡∏≤‡πÑ‡∏°‡πà‡∏ä‡∏±‡∏î ‡πÉ‡∏´‡πâ‡∏ñ‡∏∑‡∏≠‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏õ‡∏±‡∏ç‡∏´‡∏≤
                        passCount = 0;
                    }
                } catch (e) {
                    logAI(`‚ùó‡πÄ‡∏£‡∏µ‡∏¢‡∏Å API ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${e.message}`, false, true);
                }
            }
            return { success: passCount >= REQUIRED_PASSES, code: currentCode };
        }

        // extract ‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏≤‡∏Å response (DAX ‡∏´‡∏£‡∏∑‡∏≠ M)
        function extractCodeFromText(text) {
            const m = text.match(/```(?:dax|powerquery|m)?\s*([\s\S]+?)```/i);
            return m ? m[1].trim() : text; 
        }

        // ---------- ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏û‡∏£‡πâ‡∏≠‡∏° validation ‡∏ã‡πâ‡∏≥ ----------
        async function generateValidatedReport(apiKey, schemaText, context) {
            let finalReport = '';
            let daxPart = '';
            let mPart = '';

            // ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÄ‡∏ï‡πá‡∏°
            logAI('üìù ‡∏£‡∏≠‡∏ö‡∏ó‡∏µ‡πà 1: ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á...', true);
            const prompt = `‡∏ö‡∏£‡∏¥‡∏ö‡∏ó: ${context}\n\n${schemaText}\n\n‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡∏Ç‡πâ‡∏≠‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ‡πÑ‡∏ß‡πâ ‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ M Code ‡πÅ‡∏•‡∏∞ DAX Measures ‡∏ä‡∏±‡∏î‡πÄ‡∏à‡∏ô`;
            let reportDraft = await callGemini(prompt, PROMPT_REPORT_BASE, apiKey);
            
            // ‡πÅ‡∏¢‡∏Å‡∏™‡πà‡∏ß‡∏ô M ‡πÅ‡∏•‡∏∞ DAX ‡∏≠‡∏≠‡∏Å‡∏°‡∏≤‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö
            // (‡πÉ‡∏ä‡πâ‡∏ß‡∏¥‡∏ò‡∏µ extract ‡∏Ñ‡∏£‡πà‡∏≤‡∏ß‡πÜ)
            let extractedM = extractMCode(reportDraft);
            let extractedDAX = extractDAXCode(reportDraft);

            // ‡∏ï‡∏£‡∏ß‡∏à M
            if (extractedM) {
                const mValid = await validateAndFix(apiKey, extractedM, schemaText, 'M');
                if (mValid.success) {
                    reportDraft = replaceCodeBlock(reportDraft, extractedM, mValid.code, 'm');
                    extractedM = mValid.code;
                }
            }
            // ‡∏ï‡∏£‡∏ß‡∏à DAX
            if (extractedDAX) {
                const daxValid = await validateAndFix(apiKey, extractedDAX, schemaText, 'DAX');
                if (daxValid.success) {
                    reportDraft = replaceCodeBlock(reportDraft, extractedDAX, daxValid.code, 'dax');
                    extractedDAX = daxValid.code;
                }
            }

            // ‡∏£‡∏≠‡∏ö‡πÄ‡∏™‡∏£‡∏¥‡∏°: ‡∏™‡πà‡∏á‡∏Å‡∏•‡∏±‡∏ö‡πÑ‡∏õ‡πÉ‡∏´‡πâ Gemini ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏≠‡∏î‡∏Ñ‡∏•‡πâ‡∏≠‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÅ‡∏Å‡πâ
            logAI('üîÑ ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß...', true);
            const finalPrompt = `‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏£‡πà‡∏≤‡∏á: ${reportDraft}\n\n‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏ó‡∏≥‡πÉ‡∏´‡πâ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå ‡πÉ‡∏ä‡πâ M Code ‡πÅ‡∏•‡∏∞ DAX ‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÅ‡∏•‡πâ‡∏ß ‡πÇ‡∏î‡∏¢‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÇ‡∏Ñ‡πâ‡∏î\nM:\n${extractedM}\nDAX:\n${extractedDAX}`;
            finalReport = await callGemini(finalPrompt, "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠ BA ‡∏õ‡∏£‡∏±‡∏ö‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡πÉ‡∏´‡πâ‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå‡πÇ‡∏î‡∏¢‡πÉ‡∏ä‡πâ‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏µ‡πà‡πÉ‡∏´‡πâ", apiKey);
            return finalReport;
        }

        function extractMCode(text) {
            const match = text.match(/```(?:m|powerquery)\s*([\s\S]+?)```/i);
            return match ? match[1] : null;
        }
        function extractDAXCode(text) {
            const match = text.match(/```(?:dax|DAX)\s*([\s\S]+?)```/i);
            return match ? match[1] : null;
        }
        function replaceCodeBlock(full, oldCode, newCode, lang = 'm') {
            return full.replace(oldCode, newCode);
        }

        // ---------- ‡∏õ‡∏∏‡πà‡∏°‡πÄ‡∏£‡∏¥‡πà‡∏° ----------
        el.analyzeBtn.addEventListener('click', async function() {
            const apiKey = el.apiKey.value.trim();
            if (!apiKey.startsWith('AI')) { showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÉ‡∏™‡πà Gemini API Key ‡∏ó‡∏µ‡πà‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á'); return; }
            if (!el.multiFileInput.files.length) { showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏ü‡∏•‡πå‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏≠‡∏¢‡πà‡∏≤‡∏á‡∏ô‡πâ‡∏≠‡∏¢ 1 ‡πÑ‡∏ü‡∏•‡πå'); return; }
            const context = el.analysisContext.value.trim();
            if (!context) { showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å‡∏ö‡∏£‡∏¥‡∏ö‡∏ó‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå'); return; }

            // reset state
            CURRENT_API_KEY = apiKey;
            ANALYSIS_CONTEXT = context;
            el.resultsContainer.innerHTML = '';
            el.aiLog.innerHTML = '';
            el.downloadSection.classList.add('hidden');
            el.progressSection.classList.remove('hidden');
            el.aiStatusContainer.style.display = 'block';
            window.ANALYSIS_START_TIME = Date.now();
            el.analyzeBtn.disabled = true;

            try {
                // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 1: ‡∏≠‡πà‡∏≤‡∏ô schema ‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                updateProgress(10, 'üîé ‡∏≠‡πà‡∏≤‡∏ô‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÑ‡∏ü‡∏•‡πå...');
                logAI('üìñ ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏≠‡πà‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á ‡πÄ‡∏Å‡πá‡∏ö‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÅ‡∏•‡∏∞‡∏ï‡∏±‡∏ß‡∏≠‡∏¢‡πà‡∏≤‡∏á...', true);
                const schema = await readFileSchema(el.multiFileInput.files);
                FULL_SCHEMA = schema;
                FULL_SCHEMA_TEXT = buildSchemaText(schema);
                logAI(`‚úÖ ‡∏≠‡πà‡∏≤‡∏ô schema ‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à: ${Object.keys(schema).length} ‡πÑ‡∏ü‡∏•‡πå`);
                
                updateProgress(30, 'üß† ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏ä‡∏¥‡∏á‡∏•‡∏∂‡∏Å + ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ã‡πâ‡∏≥');
                logAI('‚öôÔ∏è ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏Å‡∏£‡∏∞‡∏ö‡∏ß‡∏ô‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÅ‡∏ö‡∏ö‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏ó‡∏∏‡∏Å‡πÇ‡∏Ñ‡πâ‡∏î‡∏à‡∏∞‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á', true);

                // ‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô 2: generate + validation ‡∏´‡∏•‡∏≤‡∏¢‡∏£‡∏≠‡∏ö
                const validatedReport = await generateValidatedReport(apiKey, FULL_SCHEMA_TEXT, context);
                FINAL_REPORT = validatedReport;

                updateProgress(90, 'üìä ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ñ‡∏π‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏Ç‡∏±‡πâ‡∏ô‡∏™‡∏∏‡∏î‡∏ó‡πâ‡∏≤‡∏¢');
                logAI('‚úÖ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö 100% ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô');

                // ‡πÅ‡∏™‡∏î‡∏á‡∏ú‡∏•
                displayReport(FINAL_REPORT, false);
                updateProgress(100, '‡πÄ‡∏™‡∏£‡πá‡∏à‡∏™‡∏°‡∏ö‡∏π‡∏£‡∏ì‡πå');
                el.downloadSection.classList.remove('hidden');
                el.downloadEnhancedBtn?.classList.add('hidden');
                el.copyEnhancedBtn?.classList.add('hidden');
            } catch (err) {
                logAI(`‚ùå ‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡∏•‡πâ‡∏°‡πÄ‡∏´‡∏•‡∏ß: ${err.message}`, false, true);
                showMessage('‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î: ' + err.message);
            } finally {
                el.analyzeBtn.disabled = false;
            }
        });

        // ‡πÅ‡∏™‡∏î‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô
        function displayReport(content, isEnhanced = false) {
            const id = isEnhanced ? 'enhanced-report' : 'original-report';
            const bgColor = isEnhanced ? 'border-green-300' : 'border-red-300';
            const html = `
            <div id="report-display-${id}" class="bg-white border-2 ${bgColor} rounded-2xl p-5 shadow-lg relative">
                <div class="flex justify-between items-center mb-4">
                    <h3 class="text-xl font-bold ${isEnhanced ? 'text-green-800' : 'text-red-800'}">${isEnhanced ? 'üáπüá≠ ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ + ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå' : 'üìå ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ó‡∏µ‡πà‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö 100%'}</h3>
                    <span class="text-sm text-gray-500">${new Date().toLocaleString('th-TH')}</span>
                </div>
                <div class="relative">
                    <textarea id="${id}-textarea" rows="20" class="w-full p-4 border rounded-xl bg-gray-50 font-mono text-sm resize-y" readonly>${content.replace(/</g,'&lt;')}</textarea>
                    <button id="${id}-copy-btn" class="copy-btn ${isEnhanced ? 'bg-green-700' : 'bg-red-700'} hover:bg-gray-800">üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å</button>
                </div>
            </div>`;
            el.resultsContainer.insertAdjacentHTML('afterbegin', html);
            document.getElementById(`${id}-copy-btn`).addEventListener('click', function() {
                const ta = document.getElementById(`${id}-textarea`);
                ta.select();
                navigator.clipboard.writeText(ta.value).then(() => {
                    this.textContent = '‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!';
                    setTimeout(() => this.textContent = 'üìã ‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å', 2000);
                });
            });
        }

        // ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î
        el.downloadOriginalBtn.addEventListener('click', function() {
            if (FINAL_REPORT) saveAs(new Blob([FINAL_REPORT], {type:'application/msword'}), `PowerBI_Report_${new Date().toISOString().slice(0,10)}.doc`);
            else showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô');
        });
        el.copyOriginalBtn.addEventListener('click', function() {
            if (FINAL_REPORT) navigator.clipboard.writeText(FINAL_REPORT).then(() => this.textContent='‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß!');
        });

        // ‡∏õ‡∏∏‡πà‡∏°‡∏õ‡∏£‡∏±‡∏ö‡∏õ‡∏£‡∏∏‡∏á‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡πÄ‡∏£‡∏µ‡∏¢‡∏Å‡∏≠‡∏µ‡∏Å‡∏Ñ‡∏£‡∏±‡πâ‡∏á ‡∏û‡∏£‡πâ‡∏≠‡∏°‡πÉ‡∏´‡πâ rename)
        el.enhanceReportBtn.addEventListener('click', async function() {
            if (!FINAL_REPORT) return showMessage('‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏´‡∏•‡∏±‡∏Å‡∏Å‡πà‡∏≠‡∏ô');
            if (!CURRENT_API_KEY) return showMessage('‡πÑ‡∏°‡πà‡∏°‡∏µ API Key');
            this.disabled = true;
            logAI('üáπüá≠ ‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏â‡∏ö‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ + ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå...', true);
            try {
                const prompt = `‡∏à‡∏≤‡∏Å‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏ô‡∏µ‡πâ:\n${FINAL_REPORT}\n\n‡∏à‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏≤‡∏¢‡∏á‡∏≤‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ ‡πÄ‡∏ô‡∏∑‡πâ‡∏≠‡∏´‡∏≤‡πÄ‡∏´‡∏°‡∏∑‡∏≠‡∏ô‡πÄ‡∏î‡∏¥‡∏° ‡πÅ‡∏ï‡πà‡πÄ‡∏û‡∏¥‡πà‡∏°:
- M Code ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡∏à‡∏≤‡∏Å‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏ó‡∏¢ (‡πÉ‡∏ä‡πâ Table.RenameColumns)
- ‡πÅ‡∏Å‡πâ‡πÑ‡∏Ç‡πÇ‡∏Ñ‡πâ‡∏î DAX ‡πÉ‡∏´‡πâ‡∏ä‡∏∑‡πà‡∏≠ measure ‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢ (‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏¢‡∏±‡∏á‡πÉ‡∏ä‡πâ‡∏ä‡∏∑‡πà‡∏≠‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÄ‡∏î‡∏¥‡∏°)
- ‡∏≠‡∏ò‡∏¥‡∏ö‡∏≤‡∏¢‡∏Ç‡∏±‡πâ‡∏ô‡∏ï‡∏≠‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡πÄ‡∏õ‡πá‡∏ô‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢
- ‡∏´‡πâ‡∏≤‡∏°‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ä‡∏∑‡πà‡∏≠‡∏ï‡∏≤‡∏£‡∏≤‡∏á‡∏à‡∏£‡∏¥‡∏á`;
                const enhanced = await callGemini(prompt, "‡∏Ñ‡∏∏‡∏ì‡∏Ñ‡∏∑‡∏≠‡∏ô‡∏±‡∏Å‡∏û‡∏±‡∏í‡∏ô‡∏≤ Power BI ‡∏Ñ‡∏ô‡πÑ‡∏ó‡∏¢", CURRENT_API_KEY);
                ENHANCED_REPORT = enhanced;
                displayReport(enhanced, true);
                el.downloadEnhancedBtn?.classList.remove('hidden');
                el.copyEnhancedBtn?.classList.remove('hidden');
                logAI('‚úÖ ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏â‡∏ö‡∏±‡∏ö‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à');
            } catch(e) {
                logAI('‚ùó ‡πÑ‡∏°‡πà‡∏™‡∏≥‡πÄ‡∏£‡πá‡∏à:'+e.message, false, true);
            } finally { this.disabled = false; }
        });

        el.downloadEnhancedBtn.addEventListener('click', function() {
            if (ENHANCED_REPORT) saveAs(new Blob([ENHANCED_REPORT], {type:'application/msword'}), `Thai_Dashboard_${new Date().toISOString().slice(0,10)}.doc`);
        });
        el.copyEnhancedBtn.addEventListener('click', function() {
            if (ENHANCED_REPORT) navigator.clipboard.writeText(ENHANCED_REPORT);
        });
    })();
</script>

<!-- ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ‡∏£‡∏∞‡∏ö‡∏ö‡∏≠‡πà‡∏≤‡∏ô schema ‡∏à‡∏£‡∏¥‡∏á ‡πÅ‡∏•‡∏∞‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏∏‡∏Å‡∏ö‡∏£‡∏£‡∏ó‡∏±‡∏î ‡∏ß‡∏ô‡∏ã‡πâ‡∏≥‡∏à‡∏ô‡∏Å‡∏ß‡πà‡∏≤‡∏à‡∏∞‡∏ú‡πà‡∏≤‡∏ô‡∏Å‡∏≤‡∏£‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö 100% -->
</body>
</html>